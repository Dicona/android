<!--
 Copyright 2020 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<!-- TODO: add download progress -->

<ng-container *ngIf="showModUI">
  <ng-container [ngSwitch]="entity.progressType" *ngFor="let entity of entities">
    <!-- log entry container -->
    <div class="entity log elevated-card mat-elevation-z2" *ngSwitchCase="'log'">
        <div>
          <mat-icon class="status warning" *ngIf="entity.level === EventLogLevel.WARNING">
            warning
          </mat-icon>
          <mat-icon class="status error" *ngIf="entity.level === EventLogLevel.ERROR">
            error
          </mat-icon>
          <mat-icon class="status info" *ngIf="entity.level === EventLogLevel.INFO">done</mat-icon>
        </div>
        <div>
          <span class="log-message" [innerHTML]="entity.message | linkify"></span><br>
          <span class="timestamp">Started: {{entity.timestamp | date:'MM/dd/yyyy h:mm a'}}</span>
        </div>
    </div>

    <!-- command state stats container -->
    <div class="entity command-state-stats sectioned-card mat-elevation-z2"
         *ngSwitchCase="'command-state-stats'">
      <div class="card-header">

        <div>
          <mat-icon class="status info">done</mat-icon>
        </div>
        <div>
          <span class="log-message">Test run started</span><br>
          <span class="timestamp">Started: {{entity.timestamp | date:'MM/dd/yyyy h:mm a'}}</span>
        </div>
      </div>
      <div class="card-body">
        <mat-table [dataSource]="stateStats.state_stats">
          <ng-container matColumnDef="expand">
            <mat-header-cell *matHeaderCellDef fxFlex="40px">
              <!-- Expand button column -->
            </mat-header-cell>
          </ng-container>

          <ng-container matColumnDef="jobs">
            <mat-header-cell *matHeaderCellDef fxFlex class="jobs-column">
              Jobs
            </mat-header-cell>
          </ng-container>

          <ng-container matColumnDef="module_results">
            <mat-header-cell *matHeaderCellDef fxFlex="120px">
              Module results
            </mat-header-cell>
          </ng-container>

          <ng-container matColumnDef="test_results">
            <mat-header-cell *matHeaderCellDef fxFlex="200px">
              Test results (failed/total)
            </mat-header-cell>
          </ng-container>

          <ng-container matColumnDef="start_time">
            <mat-header-cell *matHeaderCellDef fxFlex="100px">
              Start time
            </mat-header-cell>
          </ng-container>

          <ng-container matColumnDef="duration">
            <mat-header-cell *matHeaderCellDef fxFlex="100px">
              +Duration
            </mat-header-cell>
          </ng-container>

          <ng-container matColumnDef="output_files">
            <mat-header-cell *matHeaderCellDef fxFlex="100px">
              <!-- Output files column -->
            </mat-header-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="displayColumns"></mat-header-row>
        </mat-table>

        <div *ngFor="let statNode of statNodeMap | keyvalue">
          <div class="state-stat-row row-divider" *ngIf="statNode.value.count > 0">
            <div fxFlex="40px">
              <button mat-icon-button aria-label="Toggle" (click)="expandStatNode(statNode.key)"
                      class="expand-button">
                <mat-icon class="mat-icon-rtl-mirror">
                  {{statNode.value.expanded ? 'expand_more' : 'chevron_right'}}
                </mat-icon>
              </button>
            </div>

            <div fxFlex class="state-stat-text inline">
              <span>
                {{statNode.value.state | titlecase}} ({{statNode.value.count}})
              </span>
            </div>

          </div><!-- End of state stat node row -->


          <!-- Commands -->
          <ng-container *ngIf="statNode.value.expanded">
            <div *ngFor="let commandNode of statNode.value.commandNodeMap | keyvalue"
                 class="row-divider">
              <div fxFlex="20px">
                <!-- Command row indent column -->
              </div>

              <div fxFlex="40px">
                <button mat-icon-button aria-label="Toggle"
                        (click)="expandCommandNode(statNode.value.state, commandNode.key)"
                        class="expand-button">
                  <mat-icon class="mat-icon-rtl-mirror">
                    {{commandNode.value.expanded ? 'expand_more' : 'chevron_right'}}
                  </mat-icon>
                </button>
              </div>

              <div fxFlex class="job-text inline">
                <span>
                  Job {{commandNode.value.id}}: {{commandNode.value.name || commandNode.value.command_line}}
                </span>
              </div>

              <div fxFlex="120px" class="display-flex">
                <ng-container *ngIf="commandNode.value.failed_test_run_count">
                  <mat-icon *ngIf="commandNode.value.failed_test_run_count > 0"
                            class="results error">
                    error_outline
                  </mat-icon>
                  <mat-icon *ngIf="commandNode.value.failed_test_run_count == 0"
                            class="results success">
                    done
                  </mat-icon>
                  <span class="count-text">
                    {{commandNode.value.failed_test_run_count}} errors
                  </span>
                </ng-container>
              </div>

              <div fxFlex="200px" class="display-flex">
                <ng-container *ngIf="commandNode.value.failed_test_count">
                  <mat-icon *ngIf="commandNode.value.failed_test_count > 0"
                            class="results error">
                    error_outline
                  </mat-icon>
                  <mat-icon *ngIf="commandNode.value.failed_test_count == 0"
                            class="results success">
                    done
                  </mat-icon>
                  <span class="count-text">
                    {{commandNode.value.failed_test_count}}/{{commandNode.value.total_test_count}}
                  </span>
                </ng-container>
              </div>

              <div fxFlex="100px" class="row-text">
                <div>
                  {{commandNode.value.start_time | date:'h:mm:ss a'}}
                </div>
                <div class="secondary-text">
                  {{commandNode.value.start_time | date:'MM/dd/yyyy'}}
                </div>
              </div>

              <div fxFlex="100px" class="row-text secondary-text">
                  +{{getDuration(commandNode.value)}}
              </div>

              <div fxFlex="100px">
                  <!-- Output files column -->
              </div>
            </div><!-- End of command row -->
          </ng-container>

        </div>

        <div class="empty" *ngIf="!entity.state_stats.length">
          No jobs found.
        </div>
      </div>
    </div>
  </ng-container>
</ng-container>

<ng-container [ngSwitch]="entity.progressType" *ngFor="let entity of entities">
  <!-- log entry container -->
  <div class="entity log" *ngSwitchCase="'log'">
    <span class="time-column timestamp">{{entity.timestamp | date:'MM/dd/yyyy h:mm a'}}</span>
    <mat-icon class="warning status" *ngIf="entity.level === EventLogLevel.WARNING">
      warning
    </mat-icon>
    <mat-icon class="error status" *ngIf="entity.level === EventLogLevel.ERROR">
      error
    </mat-icon>
    <span class="log-message" [innerHTML]="entity.message | linkify"></span>
  </div>

  <!-- attempt container -->
  <div class="entity attempt mat-elevation-z2" *ngSwitchCase="'attempt'">
    <div class="time-column">
      <div class="timestamp">{{entity.timestamp | date:'MM/dd/yyyy h:mm a'}}</div>
      <div class="duration">+{{getDuration(entity)}}</div>
    </div>
    <div class="attempt-content">
      <div class="attempt-header">
        <div>Running "{{entity.command.name || entity.command.command_line}}" (attempt {{entity.attempt_id}})</div>
      </div>
      <attempt-status [testRun]="testRun" [attempt]="entity"></attempt-status>
    </div>
  </div>
</ng-container>

